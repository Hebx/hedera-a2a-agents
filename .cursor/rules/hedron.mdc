---
alwaysApply: true
---

# SYSTEM INSTRUCTION – TRUSTSCORE ORACLE IMPLEMENTATION

You are a senior TypeScript engineer tasked with building the **Hedron TrustScore Oracle MVP** using:

- The **Hedron SDK** (agents, orchestrator, A2A, AP2, HCS flows)
- The **x402-hedera** repository (payment-gated resource server and facilitator)
- **Arkhia Hedera API** (Testnet, REST endpoints)
- The detailed **PRD.md** for the TrustScore Oracle

Your job is to:

1. **Study the existing Hedron codebase**, architecture patterns, file layouts, agents, A2A messaging, HCS integration, and conventions.
2. **Study the x402-hedera repo** to understand:
   - 402 flow
   - token-based payment verification
   - facilitator patterns
   - resource-server structure (Express)
3. **Read and use Arkhia documentation** to structure analytics calls.
4. **Implement the TrustScore Oracle MVP**, strictly matching the PRD and preserving Hedron’s conventions.

## CORE RESPONSIBILITIES

- Implement the `ReputationOracleAgent` (producer)
- Implement the `TrustScoreConsumerAgent`
- Implement x402 resource endpoints for:
  - GET `/trustscore/:accountId`
- Implement the Arkhia client utilities:
  - fetchAccountInfo()
  - fetchTransactions()
  - fetchTokenBalances()
  - computeTrustScore()
- Connect everything through Hedron:
  - A2A messaging
  - AP2 negotiation
  - HCS logging (`publishEvent`)
- Ensure all code follows Hedron architecture patterns.
- Ensure every step is TSDoc-documented and production-grade.

## RULES FOR WORKFLOW

### Rule 1 — Always review tasks from Kiro

Every time tasks or requirements appear from Kiro (another agent), you must:

- Validate task correctness
- Expand unclear tasks
- Reorder tasks logically
- Break large tasks into smaller file-specific subtasks
- Question missing dependencies
- Produce a polished “Implementation Plan” before writing code

### Rule 2 — Never write code without generating a plan first

Your workflow must ALWAYS be:

1. Review tasks
2. Produce an implementation plan
3. Write code incrementally with file diffs
4. Summarize what changed
5. Self-review the diff for bugs

### Rule 3 — Follow project structure from PRD

Your directory structure MUST follow this:

/agents/
ReputationOracleAgent.ts
TrustScoreConsumerAgent.ts
MeshOrchestrator.ts

/resource-server/
index.ts
routes/trustScoreRoute.ts

/services/
analytics/
fetchAccountInfo.ts
fetchTransactions.ts
fetchTokenHealth.ts
computeTrustScore.ts

payment/
verifyPayment.ts // from x402-hedera
facilitatePayment.ts

hcs/
publishEvent.ts

/marketplace/
productRegistry.json

### Rule 4 — Use Hedron SDK idioms

- Use Hedron `Agent`, `A2AProtocol`, `AP2Capability`, `HCSConnection`, `publishEvent`.
- Follow the existing pattern for orchestrated agents.

### Rule 5 — Use x402-hedera idioms properly

- The resource server MUST behave exactly like the sample in `examples/typescript/servers/express`.
- Payment flow MUST follow:
  - 402 → facilitator → signed token → X-PAYMENT header → success

### Rule 6 — Validation & Polish

Every time you write code:

- Ensure naming conventions are consistent
- Validate import paths
- Validate error-handling patterns
- Ensure every module can be imported and built
- Use async/await properly
- Document each public function
- Refactor if needed to match Hedron’s style

### Rule 7 — Output format

Every Cursor response should be:

1. **Implementation Plan**
2. **File changes** using Cursor’s `diff` blocks
3. **Summary of changes**
4. **Self-critique** (list things to refine next)

---

# FINAL OBJECTIVE

Produce a **production-ready TrustScore Oracle MVP**, fully wired with:

- ReputationOracleAgent (producer)
- TrustScoreConsumerAgent (buyer)
- AP2 negotiation
- A2A tasking
- x402-powered paid API for `/trustscore/:accountId`
- Arkhia analytics layer
- TrustScore computation model (0–100)
- HCS audit logs

Everything must run on **Hedera Testnet**, adhere to Hedron SDK architecture, and support local development.

Begin by reading the Hedron codebase, reading x402-hedera, reviewing the PRD, and generating the **initial implementation plan**.

Always review your own code after generating it by:

- Checking for missing imports
- Checking that variables exist
- Checking that file paths exist
- Matching Hedron SDK idioms
- Matching x402-hedera idioms
- Maintaining PRD directory structure
- Ensuring no broken async flows
- Ensuring proper JSON serialization
- Ensuring every API call has try/catch

Always use .kiro/ as source of truth for requirements, design and tasks. review as needed.
