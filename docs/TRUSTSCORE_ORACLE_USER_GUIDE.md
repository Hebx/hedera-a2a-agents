# TrustScore Oracle User Guide

## Overview

The TrustScore Oracle is a decentralized marketplace service that provides reputation scores for Hedera accounts based on on-chain analytics. It implements a complete **A2A → AP2 → x402 → Analytics → HCS** workflow, enabling autonomous agents to buy and sell trust scores using the Hedron SDK.

### Key Features

- **Decentralized Trust Scores**: Compute reputation scores for any Hedera account
- **Payment-Gated API**: Access trust scores via x402 payment protocol
- **AP2 Negotiation**: Dynamic price negotiation between agents
- **On-Chain Analytics**: Powered by Arkhia API for real-time Hedera data
- **HCS Audit Logs**: Immutable event logging on Hedera Consensus Service
- **Autonomous Agents**: Full A2A protocol support for agent-to-agent communication

## Table of Contents

1. [Installation](#installation)
2. [Configuration](#configuration)
3. [Quick Start](#quick-start)
4. [Running Agents](#running-agents)
5. [Using the API](#using-the-api)
6. [Payment Flow](#payment-flow)
7. [Examples](#examples)
8. [Troubleshooting](#troubleshooting)
9. [Architecture](#architecture)

## Installation

### Prerequisites

- Node.js 18+ and npm
- Hedera Testnet account with HBAR
- Arkhia API key (get one at [arkhia.io](https://arkhia.io))
- Optional: Base Sepolia account for USDC payments

### Install Dependencies

```bash
npm install
```

### Build the Project

```bash
npm run build
```

## Configuration

### Environment Variables

Create a `.env` file in the project root:

```env
# Hedera Configuration
HEDERA_ACCOUNT_ID=0.0.xxxxx
HEDERA_PRIVATE_KEY=302e...
HEDERA_NETWORK=testnet

# Hedera Consensus Service
# These are created automatically by: npm run setup:agents
# OR you can use existing topics you already have
HCS_TOPIC_ID=0.0.xxxxx  # Can be any existing HCS topic
MESH_TOPIC_ID=0.0.xxxxx  # Created by setup:agents (Orchestrator inbound topic)

# Arkhia API
ARKHIA_API_KEY=your_arkhia_api_key
# Base URL is automatically set to: https://pool.arkhia.io
# Endpoint pattern: /hedera/{testnet|mainnet}/api/v1/{resource}
# No need to set ARKHIA_API_URL - it's constructed automatically based on network

# x402 Payment Configuration
PAYMENT_NETWORK=hedera-testnet  # or 'base-sepolia' for USDC
BASE_RPC_URL=https://sepolia.base.org  # Required for USDC payments
SETTLEMENT_WALLET_PRIVATE_KEY=0x...  # Required for EVM payments

# TrustScore Configuration
TRUST_SCORE_PRICE=0.3  # Price in HBAR (default: 0.3)
TRUST_SCORE_PORT=3001  # Producer server port

# Agent Configuration (OPTIONAL - auto-generated by setup script)
# These will be created automatically when you run: npm run setup:agents
PRODUCER_AGENT_ID=0.0.xxxxx  # Created by setup:agents
CONSUMER_AGENT_ID=0.0.xxxxx  # Created by setup:agents
PRODUCER_TOPIC_ID=0.0.xxxxx  # Created by setup:agents
CONSUMER_TOPIC_ID=0.0.xxxxx  # Created by setup:agents
ORCHESTRATOR_AGENT_ID=0.0.xxxxx  # Created by setup:agents
```

### How to Get Agent IDs and HCS Topics

**Agent IDs and HCS Topics are automatically created when you register agents:**

```bash
# Run the agent registration script
npm run setup:agents
```

This script will:

1. ✅ Create new Hedera accounts for each agent (Producer, Consumer, Orchestrator)
2. ✅ Create HCS topics for each agent (inbound and outbound topics)
3. ✅ Generate private keys for each agent
4. ✅ Write all credentials to your `.env` file automatically

**After running `npm run setup:agents`, you'll have:**

- `PRODUCER_AGENT_ID` - The Hedera account ID for the Producer agent
- `CONSUMER_AGENT_ID` - The Hedera account ID for the Consumer agent
- `ORCHESTRATOR_AGENT_ID` - The Hedera account ID for the Orchestrator
- `PRODUCER_TOPIC_ID` - HCS topic for Producer agent
- `CONSUMER_TOPIC_ID` - HCS topic for Consumer agent
- `MESH_TOPIC_ID` - HCS topic for Mesh Orchestrator (same as ORCHESTRATOR_TOPIC_ID)
- Private keys for each agent

**Note:**

- Agent IDs default to `HEDERA_ACCOUNT_ID` if not set, but it's recommended to create dedicated agent accounts via the setup script
- `MESH_TOPIC_ID` is the Orchestrator's inbound topic (where it receives messages)
- You can use an existing HCS topic for `HCS_TOPIC_ID` if you have one

**See [TrustScore Setup Guide](./TRUSTSCORE_SETUP_GUIDE.md) for detailed setup instructions.**

### Required Variables

**Minimum Required for Basic Setup:**

- `HEDERA_ACCOUNT_ID`: Your Hedera account ID (main account for funding agents)
- `HEDERA_PRIVATE_KEY`: Your account private key
- `ARKHIA_API_KEY`: Your Arkhia API key
- `MESH_TOPIC_ID`: HCS topic for Mesh Orchestrator (created by `setup:agents`)

**For x402 Payments:**

- `PAYMENT_NETWORK`: Network for payments (`hedera-testnet` or `base-sepolia`)
- For Hedera: Uses your `HEDERA_ACCOUNT_ID` and `HEDERA_PRIVATE_KEY`
- For EVM (Base Sepolia): Requires `BASE_RPC_URL` and `SETTLEMENT_WALLET_PRIVATE_KEY`

### Setup Steps

**Step 1: Run Agent Registration (Creates Agent IDs and Topics)**

Before running the TrustScore Oracle, register your agents:

```bash
npm run setup:agents
```

This will:

- Create Hedera accounts for Producer, Consumer, and Orchestrator agents
- Create HCS topics for each agent
- Automatically write all credentials to your `.env` file

**Step 2: Add Missing Variables**

Add these to your `.env` file:

```env
# Arkhia API (REQUIRED)
ARKHIA_API_KEY=your_arkhia_api_key_here

# Payment Network (for HBAR payments)
PAYMENT_NETWORK=hedera-testnet
```

## Quick Start

### 1. Start the Producer Agent (TrustScore API Server)

The Producer Agent runs an Express server that exposes the trust score API:

```bash
npm run demo:trustscore-oracle
```

Or programmatically:

```typescript
import { TrustScoreProducerAgent } from "./src/agents/TrustScoreProducerAgent";
import { X402FacilitatorServer } from "./src/facilitator/X402FacilitatorServer";
import { ArkhiaAnalyticsService } from "./src/services/analytics/ArkhiaAnalyticsService";
import { TrustScoreComputationEngine } from "./src/services/analytics/TrustScoreComputationEngine";
import { ProductRegistry } from "./src/marketplace/ProductRegistry";

// Initialize components
const facilitator = new X402FacilitatorServer();
const arkhiaService = new ArkhiaAnalyticsService("testnet");
const computationEngine = new TrustScoreComputationEngine();
const productRegistry = new ProductRegistry();

// Initialize producer agent
const producer = new TrustScoreProducerAgent(
  process.env.HEDERA_ACCOUNT_ID!,
  facilitator,
  arkhiaService,
  computationEngine,
  productRegistry
);

// Start the server
await producer.init();
console.log("Producer agent running on http://localhost:3001");
```

### 2. Use the Consumer Agent to Request Trust Scores

```typescript
import { TrustScoreConsumerAgent } from "./src/agents/TrustScoreConsumerAgent";
import { X402FacilitatorServer } from "./src/facilitator/X402FacilitatorServer";
import { ProductRegistry } from "./src/marketplace/ProductRegistry";

// Initialize components
const facilitator = new X402FacilitatorServer();
const productRegistry = new ProductRegistry();

// Initialize consumer agent
const consumer = new TrustScoreConsumerAgent(
  process.env.HEDERA_ACCOUNT_ID!,
  facilitator,
  productRegistry,
  "http://localhost:3001" // Producer endpoint
);

await consumer.init();

// Request trust score for an account
const accountId = "0.0.1234567";
const trustScore = await consumer.requestTrustScore(accountId);

if (trustScore) {
  console.log(`Trust Score: ${trustScore.overallScore}`);
  console.log(`Components:`, trustScore.components);
  console.log(`Risk Flags:`, trustScore.riskFlags);
}
```

## Running Agents

### Producer Agent

The Producer Agent serves the trust score API with x402 payment gating:

```bash
# Start producer agent server
npm run demo:trustscore-oracle
```

**Endpoints:**

- `GET /trustscore/:accountId` - Get trust score (requires x402 payment)
- `POST /negotiate` - AP2 negotiation endpoint
- `GET /health` - Health check

**Default Port:** 3001 (configurable via `TRUST_SCORE_PORT`)

### Consumer Agent

The Consumer Agent handles:

- Product discovery
- AP2 price negotiation
- x402 payment processing
- Trust score requests with retry logic

```typescript
// Initialize consumer agent
const consumer = new TrustScoreConsumerAgent(
  agentId,
  facilitator,
  productRegistry,
  producerEndpoint
);

// Discover available products
const products = await consumer.discoverProducts();
console.log("Available products:", products);

// Negotiate price
const offer = await consumer.negotiatePrice(
  "trustscore.basic.v1",
  "0.3",
  "HBAR"
);
console.log("Negotiated offer:", offer);

// Request trust score (handles payment automatically)
const trustScore = await consumer.requestTrustScore("0.0.1234567");
```

### Mesh Orchestrator

The Mesh Orchestrator manages agent registration and A2A communication:

```typescript
import { MeshOrchestrator } from "./src/agents/MeshOrchestrator";

const orchestrator = new MeshOrchestrator(
  process.env.HEDERA_ACCOUNT_ID!,
  process.env.MESH_TOPIC_ID!
);

await orchestrator.init();

// Register agents
await orchestrator.registerAgent(producerAgentId, "producer", {
  endpoint: "http://localhost:3001",
  capabilities: ["trustscore"],
});

await orchestrator.registerAgent(consumerAgentId, "consumer", {
  endpoint: "http://localhost:3002",
  capabilities: ["query"],
});
```

## Using the API

### Direct API Access (with x402 Payment)

#### 1. Request Payment Requirements

```bash
curl http://localhost:3001/trustscore/0.0.1234567
```

**Response (402 Payment Required):**

```json
{
  "error": {
    "code": "PAYMENT_REQUIRED",
    "message": "Payment required to access trust score",
    "payment": {
      "scheme": "exact",
      "network": "hedera-testnet",
      "asset": "HBAR",
      "payTo": "0.0.xxxxx",
      "maxAmountRequired": "0.3",
      "resource": "/trustscore/0.0.1234567",
      "description": "Trust score for account 0.0.1234567",
      "mimeType": "application/json",
      "maxTimeoutSeconds": 300
    }
  }
}
```

#### 2. Create Payment Authorization

For Hedera HBAR payments:

```typescript
const paymentPayload = {
  x402Version: 1,
  scheme: "exact",
  network: "hedera-testnet",
  payload: {
    authorization: {
      from: "0.0.your-account-id",
      value: "0.3", // HBAR amount
      to: "0.0.producer-account-id",
      validBefore: Math.floor(Date.now() / 1000) + 300,
    },
  },
};

const paymentHeader = Buffer.from(JSON.stringify(paymentPayload)).toString(
  "base64"
);
```

#### 3. Execute Payment via Facilitator

```typescript
const facilitator = new X402FacilitatorServer();

// Verify payment
const verification = await facilitator.verify(
  paymentHeader,
  paymentRequirements
);
if (!verification.isValid) {
  throw new Error("Payment verification failed");
}

// Settle payment (executes transfer)
const result = await facilitator.settle(paymentHeader, paymentRequirements);
console.log("Transaction hash:", result.txHash);
```

#### 4. Request Trust Score with Payment Header

```bash
curl -H "X-PAYMENT: <base64-encoded-payment-header>" \
     http://localhost:3001/trustscore/0.0.1234567
```

**Response (200 OK):**

```json
{
  "accountId": "0.0.1234567",
  "overallScore": 75.5,
  "components": {
    "accountAge": 80,
    "transactionDiversity": 70,
    "transferStability": 75,
    "tokenHealth": 80,
    "hcsQuality": 70
  },
  "riskFlags": [],
  "computedAt": 1699123456789,
  "dataFreshness": 300
}
```

## Payment Flow

### x402 Payment Protocol

The TrustScore Oracle uses the x402 payment protocol for payment-gated access:

1. **Initial Request** → Returns `402 Payment Required` with payment requirements
2. **Payment Authorization** → Client creates payment authorization payload
3. **Payment Verification** → Facilitator verifies payment authorization
4. **Payment Settlement** → Facilitator executes actual transfer on-chain
5. **Resource Access** → Request succeeds with payment header

### Supported Payment Methods

**Hedera HBAR (Testnet/Mainnet):**

- Native Hedera transfers via `@hashgraph/sdk`
- Automatic conversion from HBAR to tinybars
- Direct settlement on Hedera network

**EVM USDC (Base Sepolia):**

- ERC-20 token transfers via `ethers.js`
- Requires `BASE_RPC_URL` and wallet private key
- Uses `a2a-x402` library for payment processing

### Payment Verification

The facilitator verifies:

- ✅ Amount matches requirements
- ✅ Recipient matches producer account
- ✅ Payment not expired (validBefore timestamp)
- ✅ Authorization format is valid

### Payment Settlement

After verification, the facilitator:

1. Checks sender balance
2. Executes transfer transaction
3. Waits for confirmation
4. Returns transaction hash

## Examples

### Example 1: Basic Trust Score Request

```typescript
import { TrustScoreConsumerAgent } from "./src/agents/TrustScoreConsumerAgent";
import { X402FacilitatorServer } from "./src/facilitator/X402FacilitatorServer";
import { ProductRegistry } from "./src/marketplace/ProductRegistry";

// Initialize
const facilitator = new X402FacilitatorServer();
const productRegistry = new ProductRegistry();
const consumer = new TrustScoreConsumerAgent(
  "0.0.your-account-id",
  facilitator,
  productRegistry,
  "http://localhost:3001"
);

await consumer.init();

// Request trust score
const trustScore = await consumer.requestTrustScore("0.0.1234567");

if (trustScore) {
  console.log(`Account: ${trustScore.accountId}`);
  console.log(`Overall Score: ${trustScore.overallScore}/100`);
  console.log(`Account Age: ${trustScore.components.accountAge}/100`);
  console.log(
    `Transaction Diversity: ${trustScore.components.transactionDiversity}/100`
  );
  console.log(
    `Risk Flags: ${trustScore.riskFlags.length > 0 ? trustScore.riskFlags : "None"}`
  );
}
```

### Example 2: AP2 Negotiation Flow

```typescript
// Discover products
const products = await consumer.discoverProducts();
console.log("Available products:", products);

// Negotiate price
const negotiationRequest = {
  type: "AP2::NEGOTIATE",
  productId: "trustscore.basic.v1",
  maxPrice: "0.3",
  currency: "HBAR",
  rateLimit: { calls: 100, period: 86400 },
  metadata: {
    buyerAgentId: "0.0.your-account-id",
    timestamp: Date.now(),
  },
};

const offer = await consumer.negotiatePrice(
  "trustscore.basic.v1",
  "0.3",
  "HBAR"
);

if (offer) {
  console.log("Negotiated offer:");
  console.log(`  Price: ${offer.price} ${offer.currency}`);
  console.log(
    `  Rate Limit: ${offer.rateLimit.calls}/${offer.rateLimit.period}s`
  );
  console.log(`  Valid Until: ${new Date(offer.validUntil)}`);
  console.log(`  SLA: ${offer.sla.uptime} uptime, ${offer.sla.responseTime}`);
}
```

### Example 3: Batch Trust Score Requests

```typescript
const accountIds = ["0.0.1234567", "0.0.2345678", "0.0.3456789"];

const trustScores = await Promise.all(
  accountIds.map((id) => consumer.requestTrustScore(id))
);

trustScores.forEach((score, index) => {
  if (score) {
    console.log(`${accountIds[index]}: ${score.overallScore}/100`);
  } else {
    console.log(`${accountIds[index]}: Failed to get trust score`);
  }
});
```

### Example 4: Custom Trust Score Components

```typescript
import { TrustScoreComputationEngine } from "./src/services/analytics/TrustScoreComputationEngine";

const engine = new TrustScoreComputationEngine();

// Compute individual components
const accountInfo = await arkhiaService.getAccountInfo("0.0.1234567");
const transactions = await arkhiaService.getTransactions("0.0.1234567", 100);
const tokenBalances = await arkhiaService.getTokenBalances("0.0.1234567");

const components = {
  accountAge: engine.computeAccountAgeScore(accountInfo),
  diversity: engine.computeDiversityScore(transactions),
  volatility: engine.computeVolatilityScore(transactions),
  tokenHealth: engine.computeTokenHealthScore(tokenBalances),
  hcsQuality: engine.computeHCSQualityScore(accountInfo),
};

console.log("Trust Score Components:", components);
```

## Troubleshooting

### Common Issues

#### 1. Payment Verification Fails

**Error:** `Payment verification failed: Amount mismatch`

**Solution:**

- Ensure payment amount matches requirements exactly
- Check that price format is consistent (HBAR: "0.3", not "30000")
- Verify `TRUST_SCORE_PRICE` environment variable format

#### 2. HCS Connection Errors

**Error:** `Failed to retrieve profile for account ID`

**Solution:**

- HCS-11 profiles may not be registered on external CDN
- Agent will continue without HCS logging (non-critical)
- To enable HCS logging, register profile using Hedron SDK

#### 3. Arkhia API Errors

**Error:** `Request failed with status code 404/400`

**Solution:**

- Verify `ARKHIA_API_KEY` is set correctly
- Check `ARKHIA_API_URL` format: `https://pool.arkhia.io/hedera/testnet/api/v1`
- Ensure network matches (testnet/mainnet)

#### 4. Payment Settlement Fails

**Error:** `Cannot convert 0.3 to a BigInt`

**Solution:**

- This is fixed in latest version
- Ensure you're using the latest code with BigInt conversion fix
- Verify payment amount format is "0.3" (HBAR) not "30000" (tinybars)

#### 5. Agent Registration Fails

**Error:** `Cannot find inbound topic for agent`

**Solution:**

- Ensure `MESH_TOPIC_ID` is set correctly
- Agents need HCS topics for A2A communication
- Topic must exist and agent must have permission to publish

### Debug Mode

Enable verbose logging:

```typescript
// Set environment variable
process.env.DEBUG = "true";

// Or in .env file
DEBUG = true;
```

### Testing

Run test suite:

```bash
# Unit tests
npm run test:unit

# Integration tests
npm run test:integration

# E2E tests
npm run test:e2e

# TrustScore-specific tests
npm run test:trustscore-integration
npm run test:trustscore-e2e
```

## Architecture

### Component Overview

```
┌─────────────────────────────────────────────────────────┐
│                    TrustScore Oracle                     │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐      ┌──────────────┐                │
│  │   Producer   │      │   Consumer   │                │
│  │    Agent     │◄────►│    Agent     │                │
│  └──────┬───────┘      └──────┬───────┘                │
│         │                     │                          │
│         │                     │                          │
│  ┌──────▼─────────────────────▼──────┐                 │
│  │      Mesh Orchestrator             │                 │
│  │  (A2A Communication & Logging)     │                 │
│  └──────┬─────────────────────────────┘                 │
│         │                                                 │
│  ┌──────▼──────┐  ┌──────────────┐  ┌─────────────┐   │
│  │  x402       │  │   Arkhia     │  │     HCS     │   │
│  │ Facilitator │  │   Analytics  │  │  (Audit)    │   │
│  └─────────────┘  └──────────────┘  └─────────────┘   │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

### Data Flow

1. **Consumer** requests trust score → Producer API
2. **Producer** returns `402 Payment Required` → Payment requirements
3. **Consumer** creates payment authorization → Facilitator
4. **Facilitator** verifies payment → Settlement
5. **Producer** fetches data from Arkhia → Computation engine
6. **Producer** computes trust score → Returns result
7. **Mesh Orchestrator** logs event to HCS → Audit trail

### Trust Score Computation

The trust score (0-100) combines:

- **Account Age** (20%): Based on account creation time
- **Transaction Diversity** (20%): Variety of transaction types
- **Transfer Stability** (20%): Consistency of transfer patterns
- **Token Health** (20%): Token balance distribution
- **HCS Quality** (20%): HCS topic interaction quality

**Risk Flags:**

- High volatility
- Suspicious patterns
- Low activity
- Unusual token distributions

## Additional Resources

- **PRD**: See `prd.md` for detailed requirements
- **Design Doc**: See `.kiro/specs/trustscore-oracle/design.md` for architecture
- **API Docs**: See `docs/TRUSTSCORE_ORACLE_API.md` for API reference
- **Hedron SDK**: See `SDK_README.md` for SDK documentation
- **x402 Protocol**: See `docs/BOUNTY_1_HEDERA_X402_STANDARD.md`

## Support

For issues or questions:

1. Check troubleshooting section above
2. Review test files for usage examples
3. Check logs for detailed error messages
4. Verify environment variables are set correctly

---

**Version:** 1.0.0  
**Last Updated:** November 2024  
**Hedera Network:** Testnet (configurable for Mainnet)
